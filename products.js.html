const elCatalog = document.getElementById("catalog");
const elQ = document.getElementById("q");
const elCat = document.getElementById("cat");
const elCount = document.getElementById("count");
const clearBtn = document.getElementById("clearBtn");
const toast = document.getElementById("toast");

function showToast(msg){
  toast.textContent = msg;
  toast.classList.add("show");
  clearTimeout(showToast._t);
  showToast._t = setTimeout(()=>toast.classList.remove("show"), 2200);
}
function normalize(s){ return (s || "").toLowerCase().trim(); }

function renderCategoryOptions(){
  const options = [
    { value: "all", label: "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" },
    ...CATALOG.map(c => ({ value: c.id, label: `${c.icon} ${c.title}` }))
  ];
  elCat.innerHTML = options.map(o => `<option value="${o.value}">${o.label}</option>`).join("");
}

function matchItem(q, item){
  if(!q) return true;
  const hay = normalize(item.name + " " + item.use);
  return hay.includes(q);
}
function matchCategory(q, cat){
  if(!q) return true;
  const hay = normalize(cat.title + " " + cat.desc);
  return hay.includes(q) || cat.items.some(it => matchItem(q, it));
}

function render(){
  const q = normalize(elQ.value);
  const selected = elCat.value;

  const filtered = CATALOG
    .filter(cat => selected === "all" ? true : cat.id === selected)
    .map(cat => {
      const items = q ? cat.items.filter(it => matchItem(q, it)) : cat.items;
      return { ...cat, items };
    })
    .filter(cat => {
      if(!q) return true;
      return matchCategory(q, cat) && cat.items.length > 0;
    });

  elCount.textContent = filtered.length;

  elCatalog.innerHTML = filtered.map(cat => {
    const itemsHtml = cat.items.map(it => `
      <div class="item">
        <p class="name">${it.name}</p>
        <p class="use">${it.use}</p>
      </div>
    `).join("");

    // ‚úÖ ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏´‡∏°‡∏ß‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ "‡∏î‡∏π‡∏´‡∏°‡∏ß‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß"
    return `
      <section class="card" style="cursor:pointer" onclick="openCategory('${cat.id}')">
        <p class="cat-title">${cat.icon} ${cat.title}</p>
        <p class="cat-desc">${cat.desc}</p>
        <div class="items">${itemsHtml || `<p class="muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏¢‡πà‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</p>`}</div>
      </section>
    `;
  }).join("");

  if(filtered.length === 0){
    elCatalog.innerHTML = `
      <section class="card">
        <p style="margin:0; font-weight:900;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ü•≤</p>
        <p class="sub">‡∏•‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏≥‡∏≠‡∏∑‡πà‡∏ô ‡πÄ‡∏ä‡πà‡∏ô ‚Äú‡∏ó‡πà‡∏≠‚Äù ‚Äú‡∏û‡∏∑‡πâ‡∏ô‚Äù ‚Äú‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡∏≤‚Äù ‚Äú‡∏Å‡∏±‡∏ô‡∏•‡∏∑‡πà‡∏ô‚Äù</p>
      </section>
    `;
  }
}

function openCategory(catId){
  // ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô url ‡πÄ‡∏ä‡πà‡∏ô products.html?cat=rebar
  const url = new URL(window.location.href);
  url.searchParams.set("cat", catId);
  window.location.href = url.toString();
}

// ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡πà‡∏≤ cat ‡∏à‡∏≤‡∏Å url ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
function initFromQuery(){
  const url = new URL(window.location.href);
  const cat = url.searchParams.get("cat");
  if(cat){
    elCat.value = cat;
    // ‡πÉ‡∏™‡πà toast ‡∏õ‡∏∏‡πä‡∏ö‡πÜ ‡πÉ‡∏´‡πâ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏´‡∏°‡∏î‡∏î‡∏π‡∏´‡∏°‡∏ß‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
    showToast("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏π‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ ‚úÖ");
  }
}

elQ.addEventListener("input", render);
elCat.addEventListener("change", () => {
  // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô select ‡πÉ‡∏´‡πâ‡∏•‡πâ‡∏≤‡∏á query cat ‡∏î‡πâ‡∏ß‡∏¢
  const url = new URL(window.location.href);
  url.searchParams.delete("cat");
  history.replaceState({}, "", url.toString());
  render();
});
clearBtn.addEventListener("click", () => {
  elQ.value = "";
  elCat.value = "all";
  const url = new URL(window.location.href);
  url.searchParams.delete("cat");
  history.replaceState({}, "", url.toString());
  render();
  showToast("‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß ‚úÖ");
});

// init
renderCategoryOptions();
initFromQuery();
render();
